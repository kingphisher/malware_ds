Malware Data Science - Chapter 2
Beyond Basic Static Analysis: x86 Disassembly


Disassembly Methods
  Disassembly is the process by which we translate malware's binary code into valid x86 assembly language.

Basics of x86 Assembly Code
  Assembly language is the lowest-level human-readable programming language for a given architecture.
  There are two major dialects of x86 disassembly:
    - Intel
    - AT&T
  # Cpu Registers
      Registers are small data storage units on which x86 CPUs perform computations.
      @ General-Purpose Registers
          On a 32-bit system, registers contain 32, 16, or 8 bits of space which we can:
            - Arithmetic operations
            - Bitwise operations
            - Byte order-swapping operations
            - and more
          In compuatational workflows, programs:
            1. Move data into registers from memory or external hardware
            2. Perform some operations on this data
            3. Move the data back out to memory for storage
      @ Stack and Control Flow Registers
          The stack management registers store critical information about the program stack, which is responsible for:
            - Storing local variables for functions and arguments passed into functions
            - Control information relating to the program control flow
          + ESP register points to the top of the st    `ack.
          + EBP register points to the bottom of the stack.
          + EIP register contains the memory address of the the currently executing instruction.
          + ELAGS is a status register that contains CPU flags, which store status about the state of the executing program.
  # Arithmetic Instructions
      Instructions operate on general-purpose registers.
      -----------------------------------------------------------------------------------------------------
      |   Instructions                  Description                                                       |
      -----------------------------------------------------------------------------------------------------
      |  add ebx, 100            Adds 100 to the value in EBX and then stores the result in EBX           |
      |  sub ebx, 100            Subtracts 100 from the value in EBX and the stores the result in EBX     |
      |  inc ah                  Increments the value in AH by 1                                          |
      |  dec al                  Decrements the value in al by 1                                          |
      -----------------------------------------------------------------------------------------------------
  # Data Movement Instructions
      -----------------------------------------------------------------------------------------------------
      |   Instructions                  Description                                                       |
      -----------------------------------------------------------------------------------------------------
      |  mov ebx,eax                  Moves the value in register EAX into register EBX                   |
      |  mov eax, [0x12345678]        Moves the data at memory address 0x12345678 into the EAX register   |
      |  mov edx, 1                   Moves the value 1 into the EDX register                             |
      |  mov [0x12345678], eax        Moves the value in EAX into the memory location 0x12345678          |
      -----------------------------------------------------------------------------------------------------
      @ Stack Instructions
          Stack in x86 assembly is a data structure that allows you to push and pop values onto and off of it.
            - The push instruction pushes values onto the program stack to save a register value onto the stack.
            - The pop instruction deletes values from the stack and places them into a designated register.
      @ Control Flow Instructions
          Control flow defines the network of:
            - Possible instruction a program may execute
            - Device interactions
            - Other input the program may receive
          + call instruction does two things:
            1. Pushes the address of the instruction that will execute after the function call returns onto the top of the stack.
            2. It replaces the current value of EIP with the value specified by the address operand.
          + ret instruction:
            1. Pops the top value off the stack
            2. Then it places the popped program counter back into EIP and resumes execution.
          + jpm instruction:
              Tells the CPU to move to the memory address specified as its parameter and begin execution there.
          + cpm instruction:
              Checks the value in some register against some test value and stores the result of that test in the EFLAGS register
      @ Basic Blocks and Control Flow Graphs
          Basic block is a sequence of instructions that we know will always execute contiguously.
          Basic block always ends with either:
            - A branching instruction
            - Or an instruction that is the target of the branch
          Basic block always begins with either:
            - The first instruction of the program, called the entry point
            - Or a branch target

Factors That Limit Static Analysis
  # Packing
      Malware packing is the process by which malware authors compress, encrypt, or mangle their malicious program.
  # Resource Obfuscation
      Malware authors obfuscate the way program resources, such as strings and graphical images, are stored on disk.
  # Anti-disassembly Techniques
      - Hide code from malware analysts.
      - Make malware analysts think that a block of code stored on the disk contains different insturctions than it actually does.
  # Dynamically Downloaded Data
      A malware may load code dynamically from an external server at malware startup time.